{% extends "base.html" %}

{% block title %}设置 - 通用智能学习系统{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-white p-4 rounded-3 shadow-sm border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-primary mb-1"><i class="fas fa-cog me-2"></i>系统设置</h2>
                <p class="text-muted mb-0">配置AI模型、管理课程和其他系统设置</p>
            </div>
            <div>
                <span class="badge bg-light text-dark border p-2"><i class="fas fa-server me-1"></i>状态: 运行中</span>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- AI模型设置 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="mb-0 fw-bold text-uppercase text-muted small"><i class="fas fa-robot me-2"></i>AI模型配置</h6>
            </div>
            <div class="card-body p-4">
                <form id="ollama-settings-form">
                    <div class="mb-4">
                        <label for="ollama-api-url" class="form-label fw-bold small text-muted">Ollama API地址</label>
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fas fa-network-wired text-muted"></i></span>
                            <input type="url" class="form-control border-start-0 ps-0" id="ollama-api-url"
                                value="{{ settings.get('ollama_api_url', 'http://127.0.0.1:11434/api/chat') }}"
                                placeholder="http://127.0.0.1:11434/api/chat">
                        </div>
                        <div class="form-text small">本地部署Ollama服务的API访问地址</div>
                    </div>

                    <div class="mb-4">
                        <label for="ollama-model" class="form-label fw-bold small text-muted">AI模型选择</label>
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fas fa-brain text-muted"></i></span>
                            <select class="form-select border-start-0 ps-0" id="ollama-model">
                                <option value="">选择模型...</option>
                                {% for model in available_models %}
                                <option value="{{ model }}" {% if model==settings.get('ollama_model') %}selected{% endif
                                    %}>
                                    {{ model }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="refreshModels()"
                                title="刷新模型列表">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex mt-4">
                        <button type="button" class="btn btn-outline-primary shadow-sm flex-grow-1"
                            onclick="testConnection()">
                            <i class="fas fa-plug me-1"></i>测试连接
                        </button>
                        <button type="submit" class="btn btn-primary shadow-sm flex-grow-1">
                            <i class="fas fa-save me-1"></i>保存设置
                        </button>
                    </div>

                    <div id="connection-status" class="mt-3" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 课程管理 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="mb-0 fw-bold text-uppercase text-muted small"><i class="fas fa-book me-2"></i>课程管理</h6>
            </div>
            <div class="card-body p-4">
                <!-- 添加课程 -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle me-1 text-success"></i>添加新课程</h6>
                        <form id="add-course-form">
                            <div class="mb-2">
                                <input type="text" class="form-control shadow-sm" id="course-name"
                                    placeholder="课程名称（如：操作系统原理）" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control shadow-sm" id="course-description" rows="2"
                                    placeholder="简要描述课程内容..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm w-100 shadow-sm fw-bold">
                                <i class="fas fa-magic me-1"></i>AI自动生成知识库
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 课程列表 -->
                <div>
                    <h6 class="fw-bold mb-3 small text-muted text-uppercase">已有课程列表</h6>
                    <div id="courses-list" class="list-group shadow-sm">
                        {% for course in courses %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-0 mb-1 rounded-2 course-item"
                            data-course-name="{{ course.name }}">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark">{{ course.name }}</h6>
                                    {% if course.description %}
                                    <small class="text-muted text-truncate d-block" style="max-width: 200px;">{{
                                        course.description }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                {% if course.name != '数据库原理' %}
                                <button class="btn btn-sm btn-outline-danger btn-icon rounded-circle"
                                    onclick="deleteCourse('{{ course.name }}')" title="删除课程">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% else %}
                                <span class="badge bg-primary rounded-pill">系统默认</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 系统信息 -->
    <div class="col-12">
        <div class="card shadow-lg border-0 bg-primary text-white"
            style="background: linear-gradient(45deg, #4e54c8, #8f94fb);">
            <div class="card-header border-bottom border-white border-opacity-25 py-3">
                <h6 class="mb-0 fw-bold text-uppercase"><i class="fas fa-info-circle me-2"></i>系统概览</h6>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 border-end border-white border-opacity-25">
                        <h6 class="mb-3 opacity-75">当前运行环境</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="fas fa-microchip me-2 opacity-50"></i><strong>AI模型:</strong> {{
                                settings.get('ollama_model', '未配置') }}</li>
                            <li class="mb-2"><i class="fas fa-link me-2 opacity-50"></i><strong>API服务端点:</strong> {{
                                settings.get('ollama_api_url', '未配置') }}</li>
                            <li><i class="fas fa-graduation-cap me-2 opacity-50"></i><strong>当前激活课程:</strong> {{
                                settings.get('current_course', '数据库原理') }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6 ps-md-4 mt-3 mt-md-0">
                        <h6 class="mb-3 opacity-75">操作指南</h6>
                        <ul class="list-unstyled mb-0 small opacity-75">
                            <li class="mb-1"><i class="fas fa-check me-2"></i>请确保本地 Ollama 服务已启动且 API 可访问</li>
                            <li class="mb-1"><i class="fas fa-check me-2"></i>首次配置后建议点击“测试连接”验证</li>
                            <li class="mb-1"><i class="fas fa-check me-2"></i>新建课程时 AI 需要约 1-3 分钟生成初始知识库</li>
                            <li><i class="fas fa-exclamation-triangle me-2"></i>删除课程是不可逆操作，请谨慎执行</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger">确认删除课程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3 text-danger opacity-25">
                    <i class="fas fa-trash-alt fa-4x"></i>
                </div>
                <p class="mb-1 fs-5">确定要删除课程 <span class="fw-bold text-dark" id="delete-course-name"></span> 吗？</p>
                <p class="text-muted small">此操作将永久删除该课程及其所有知识库数据，无法恢复。</p>
            </div>
            <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger px-4 shadow-sm"
                    onclick="confirmDeleteCourse()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let deleteCourseName = '';

    $(document).ready(function () {
        // Ollama设置表单提交
        $('#ollama-settings-form').submit(function (e) {
            e.preventDefault();
            saveOllamaSettings();
        });

        // 添加课程表单提交
        $('#add-course-form').submit(function (e) {
            e.preventDefault();
            addCourse();
        });
    });

    function refreshModels() {
        const btn = event.currentTarget;
        const icon = btn.querySelector('i');
        icon.className = 'fas fa-spinner fa-spin';
        btn.disabled = true;

        $.get('/api/settings/ollama/models')
            .done(function (data) {
                if (data.success) {
                    const select = $('#ollama-model');
                    const currentValue = select.val();
                    select.empty().append('<option value="">选择模型...</option>');

                    data.models.forEach(model => {
                        const selected = model === currentValue ? 'selected' : '';
                        select.append(`<option value="${model}" ${selected}>${model}</option>`);
                    });

                    showAlert('模型列表已刷新', 'success');
                } else {
                    showAlert('刷新失败: ' + data.error, 'danger');
                }
            })
            .fail(function () {
                showAlert('网络错误，请稍后重试', 'danger');
            })
            .always(function () {
                icon.className = 'fas fa-sync-alt';
                btn.disabled = false;
            });
    }

    function testConnection() {
        const apiUrl = $('#ollama-api-url').val();
        const modelName = $('#ollama-model').val();

        if (!apiUrl || !modelName) {
            showAlert('请先填写API地址和选择模型', 'warning');
            return;
        }

        const statusDiv = $('#connection-status');
        statusDiv.show().html(`
        <div class="alert alert-info border-0 shadow-sm">
            <i class="fas fa-spinner fa-spin me-2"></i>正在测试连接，请稍候...
        </div>
    `);

        $.ajax({
            url: '/api/settings/ollama/test',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                api_url: apiUrl,
                model_name: modelName
            })
        })
            .done(function (data) {
                if (data.success) {
                    statusDiv.html(`
                <div class="alert alert-success border-0 shadow-sm">
                    <h6 class="alert-heading fw-bold mb-1"><i class="fas fa-check-circle me-2"></i>连接成功</h6>
                    <p class="mb-0 small">${data.message}</p>
                    ${data.response ? `<div class="mt-2 p-2 bg-white bg-opacity-50 rounded small">AI响应: ${data.response}</div>` : ''}
                </div>
            `);
                } else {
                    statusDiv.html(`
                <div class="alert alert-danger border-0 shadow-sm">
                    <h6 class="alert-heading fw-bold mb-1"><i class="fas fa-exclamation-circle me-2"></i>连接失败</h6>
                    <p class="mb-0 small">${data.message}</p>
                </div>
            `);
                }
            })
            .fail(function () {
                statusDiv.html(`
            <div class="alert alert-danger border-0 shadow-sm">
                <i class="fas fa-exclamation-circle me-2"></i>网络错误，请稍后重试
            </div>
        `);
            });
    }

    function saveOllamaSettings() {
        const apiUrl = $('#ollama-api-url').val();
        const modelName = $('#ollama-model').val();

        if (!apiUrl || !modelName) {
            showAlert('请填写完整的设置信息', 'warning');
            return;
        }

        $.ajax({
            url: '/api/settings/ollama/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                api_url: apiUrl,
                model_name: modelName
            })
        })
            .done(function (data) {
                if (data.success) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert('保存失败: ' + data.error, 'danger');
                }
            })
            .fail(function () {
                showAlert('网络错误，请稍后重试', 'danger');
            });
    }

    function addCourse() {
        const courseName = $('#course-name').val().trim();
        const description = $('#course-description').val().trim();

        if (!courseName) {
            showAlert('请输入课程名称', 'warning');
            return;
        }

        // 显示加载状态
        const submitBtn = $('#add-course-form button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>AI生成中...').prop('disabled', true);

        $.ajax({
            url: '/api/courses/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: courseName,
                description: description
            })
        })
            .done(function (data) {
                if (data.success) {
                    showAlert('课程创建成功！', 'success');
                    $('#course-name').val('');
                    $('#course-description').val('');
                    // 刷新课程列表
                    location.reload();
                } else {
                    showAlert('创建失败: ' + data.error, 'danger');
                }
            })
            .fail(function () {
                showAlert('网络错误，请稍后重试', 'danger');
            })
            .always(function () {
                submitBtn.html(originalText).prop('disabled', false);
            });
    }

    function deleteCourse(courseName) {
        deleteCourseName = courseName;
        $('#delete-course-name').text(courseName);
        $('#deleteConfirmModal').modal('show');
    }

    function confirmDeleteCourse() {
        if (!deleteCourseName) return;

        $.ajax({
            url: `/api/courses/${encodeURIComponent(deleteCourseName)}/delete`,
            method: 'DELETE'
        })
            .done(function (data) {
                if (data.success) {
                    showAlert(data.message, 'success');
                    $(`.course-item[data-course-name="${deleteCourseName}"]`).remove();
                    $('#deleteConfirmModal').modal('hide');
                } else {
                    showAlert('删除失败: ' + data.error, 'danger');
                }
            })
            .fail(function () {
                showAlert('网络错误，请稍后重试', 'danger');
            });
    }

    function showAlert(message, type) {
        const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle';
        const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show shadow-sm border-0" role="alert">
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        // 移除现有的alert
        $('.alert').remove();

        // 添加新的alert到页面顶部
        $('main').prepend(alertHtml);

        // 自动消失
        setTimeout(() => {
            $('.alert').fadeOut();
        }, 5000);
    }
</script>
{% endblock %}