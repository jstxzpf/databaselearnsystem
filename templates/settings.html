{% extends "base.html" %}

{% block title %}设置 - 数据库学习系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog me-2"></i>系统设置</h2>
        <p class="text-muted">配置AI模型、管理课程和其他系统设置</p>
    </div>
</div>

<div class="row">
    <!-- AI模型设置 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI模型配置
                </h5>
            </div>
            <div class="card-body">
                <form id="ollama-settings-form">
                    <div class="mb-3">
                        <label for="ollama-api-url" class="form-label">Ollama API地址</label>
                        <input type="url" class="form-control" id="ollama-api-url" 
                               value="{{ settings.get('ollama_api_url', 'http://127.0.0.1:11434/api/chat') }}"
                               placeholder="http://127.0.0.1:11434/api/chat">
                        <div class="form-text">Ollama服务的API地址</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ollama-model" class="form-label">AI模型</label>
                        <select class="form-select" id="ollama-model">
                            <option value="">选择模型...</option>
                            {% for model in available_models %}
                            <option value="{{ model }}" 
                                    {% if model == settings.get('ollama_model') %}selected{% endif %}>
                                {{ model }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshModels()">
                                <i class="fas fa-sync-alt me-1"></i>刷新模型列表
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2 d-md-flex">
                            <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>测试连接
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>保存设置
                            </button>
                        </div>
                    </div>
                    
                    <div id="connection-status" class="mt-3" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 课程管理 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>课程管理
                </h5>
            </div>
            <div class="card-body">
                <!-- 添加课程 -->
                <div class="mb-4">
                    <h6>添加新课程</h6>
                    <form id="add-course-form">
                        <div class="mb-2">
                            <input type="text" class="form-control" id="course-name" 
                                   placeholder="课程名称（如：操作系统原理）" required>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="course-description" rows="2" 
                                      placeholder="课程描述（可选）"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas fa-magic me-1"></i>AI生成知识库
                        </button>
                    </form>
                </div>
                
                <hr>
                
                <!-- 课程列表 -->
                <div class="mb-3">
                    <h6>已有课程</h6>
                    <div id="courses-list">
                        {% for course in courses %}
                        <div class="d-flex justify-content-between align-items-center mb-2 course-item" 
                             data-course-name="{{ course.name }}">
                            <div>
                                <strong>{{ course.name }}</strong>
                                {% if course.description %}
                                <br><small class="text-muted">{{ course.description }}</small>
                                {% endif %}
                            </div>
                            <div>
                                {% if course.name != '数据库原理' %}
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteCourse('{{ course.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% else %}
                                <span class="badge bg-primary">默认</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 系统信息 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>系统信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>当前配置</h6>
                        <ul class="list-unstyled">
                            <li><strong>AI模型:</strong> {{ settings.get('ollama_model', '未配置') }}</li>
                            <li><strong>API地址:</strong> {{ settings.get('ollama_api_url', '未配置') }}</li>
                            <li><strong>当前课程:</strong> {{ settings.get('current_course', '数据库原理') }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>使用说明</h6>
                        <ul class="list-unstyled small">
                            <li>• 确保Ollama服务正在运行</li>
                            <li>• 测试连接确保AI功能正常</li>
                            <li>• 生成新课程需要几分钟时间</li>
                            <li>• 删除课程将同时删除知识库文件</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除课程 "<span id="delete-course-name"></span>" 吗？</p>
                <p class="text-danger small">此操作将删除课程的知识库文件，无法恢复。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCourse()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let deleteCourseName = '';

$(document).ready(function() {
    // Ollama设置表单提交
    $('#ollama-settings-form').submit(function(e) {
        e.preventDefault();
        saveOllamaSettings();
    });
    
    // 添加课程表单提交
    $('#add-course-form').submit(function(e) {
        e.preventDefault();
        addCourse();
    });
});

function refreshModels() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>刷新中...';
    btn.disabled = true;
    
    $.get('/api/settings/ollama/models')
        .done(function(data) {
            if (data.success) {
                const select = $('#ollama-model');
                const currentValue = select.val();
                select.empty().append('<option value="">选择模型...</option>');
                
                data.models.forEach(model => {
                    const selected = model === currentValue ? 'selected' : '';
                    select.append(`<option value="${model}" ${selected}>${model}</option>`);
                });
                
                showAlert('模型列表已刷新', 'success');
            } else {
                showAlert('刷新失败: ' + data.error, 'danger');
            }
        })
        .fail(function() {
            showAlert('网络错误，请稍后重试', 'danger');
        })
        .always(function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function testConnection() {
    const apiUrl = $('#ollama-api-url').val();
    const modelName = $('#ollama-model').val();
    
    if (!apiUrl || !modelName) {
        showAlert('请先填写API地址和选择模型', 'warning');
        return;
    }
    
    const statusDiv = $('#connection-status');
    statusDiv.show().html(`
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>正在测试连接...
        </div>
    `);
    
    $.ajax({
        url: '/api/settings/ollama/test',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            api_url: apiUrl,
            model_name: modelName
        })
    })
    .done(function(data) {
        if (data.success) {
            statusDiv.html(`
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>${data.message}
                    ${data.response ? `<br><small>AI响应: ${data.response}</small>` : ''}
                </div>
            `);
        } else {
            statusDiv.html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                </div>
            `);
        }
    })
    .fail(function() {
        statusDiv.html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>网络错误，请稍后重试
            </div>
        `);
    });
}

function saveOllamaSettings() {
    const apiUrl = $('#ollama-api-url').val();
    const modelName = $('#ollama-model').val();
    
    if (!apiUrl || !modelName) {
        showAlert('请填写完整的设置信息', 'warning');
        return;
    }
    
    $.ajax({
        url: '/api/settings/ollama/save',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            api_url: apiUrl,
            model_name: modelName
        })
    })
    .done(function(data) {
        if (data.success) {
            showAlert(data.message, 'success');
        } else {
            showAlert('保存失败: ' + data.error, 'danger');
        }
    })
    .fail(function() {
        showAlert('网络错误，请稍后重试', 'danger');
    });
}

function addCourse() {
    const courseName = $('#course-name').val().trim();
    const description = $('#course-description').val().trim();
    
    if (!courseName) {
        showAlert('请输入课程名称', 'warning');
        return;
    }
    
    // 显示加载状态
    const submitBtn = $('#add-course-form button[type="submit"]');
    const originalText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>AI生成中...').prop('disabled', true);
    
    $.ajax({
        url: '/api/courses/create',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: courseName,
            description: description
        })
    })
    .done(function(data) {
        if (data.success) {
            showAlert('课程创建成功！', 'success');
            $('#course-name').val('');
            $('#course-description').val('');
            // 刷新课程列表
            location.reload();
        } else {
            showAlert('创建失败: ' + data.error, 'danger');
        }
    })
    .fail(function() {
        showAlert('网络错误，请稍后重试', 'danger');
    })
    .always(function() {
        submitBtn.html(originalText).prop('disabled', false);
    });
}

function deleteCourse(courseName) {
    deleteCourseName = courseName;
    $('#delete-course-name').text(courseName);
    $('#deleteConfirmModal').modal('show');
}

function confirmDeleteCourse() {
    if (!deleteCourseName) return;
    
    $.ajax({
        url: `/api/courses/${encodeURIComponent(deleteCourseName)}/delete`,
        method: 'DELETE'
    })
    .done(function(data) {
        if (data.success) {
            showAlert(data.message, 'success');
            $(`.course-item[data-course-name="${deleteCourseName}"]`).remove();
            $('#deleteConfirmModal').modal('hide');
        } else {
            showAlert('删除失败: ' + data.error, 'danger');
        }
    })
    .fail(function() {
        showAlert('网络错误，请稍后重试', 'danger');
    });
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 移除现有的alert
    $('.alert').remove();
    
    // 添加新的alert到页面顶部
    $('main').prepend(alertHtml);
    
    // 自动消失
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
{% endblock %}
