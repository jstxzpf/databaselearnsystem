{% extends "base.html" %}

{% block title %}å­¦ä¹  - é€šç”¨æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<!-- Mermaid CSS -->
<style>
    .mermaid {
        text-align: center;
        margin: 20px 0;
    }

    .explanation-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .explanation-content table th,
    .explanation-content table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: left;
    }

    .explanation-content table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .explanation-content table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .explanation-content h2 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-top: 25px;
        margin-bottom: 15px;
    }

    .explanation-content h3 {
        color: #6c757d;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .explanation-content code {
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }

    .explanation-content pre {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-book me-2"></i>æ™ºèƒ½å­¦ä¹ </h2>
            <div>
                <button class="btn btn-outline-primary btn-sm" onclick="showProgress()">
                    <i class="fas fa-chart-line me-1"></i>å­¦ä¹ è¿›åº¦
                </button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search me-1"></i>æœç´¢çŸ¥è¯†ç‚¹
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Mobile Toggle Button -->
    <div class="col-12 d-lg-none mb-3">
        <button class="btn btn-primary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#courseNav">
            <i class="fas fa-list me-2"></i>æµè§ˆç« èŠ‚ä¸çŸ¥è¯†ç‚¹
        </button>
    </div>

    <!-- Navigation Sidebar (Offcanvas on mobile, Column on desktop) -->
    <div class="col-lg-5">
        <div class="offcanvas-lg offcanvas-start" tabindex="-1" id="courseNav">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">è¯¾ç¨‹å¯¼èˆª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                    data-bs-target="#courseNav"></button>
            </div>
            <div class="offcanvas-body p-0">
                <div class="row w-100 m-0">
                    <!-- ç« èŠ‚åˆ—è¡¨ -->
                    <div class="col-md-5 p-0 pe-md-2 mb-3 mb-md-0">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>ç« èŠ‚åˆ—è¡¨</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="chapters-list"
                                    style="max-height: 600px; overflow-y: auto;">
                                    {% for chapter in chapters %}
                                    <a href="#" class="list-group-item list-group-item-action chapter-item"
                                        data-chapter="{{ chapter }}">
                                        <small>{{ chapter }}</small>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¦‚å¿µå’ŒçŸ¥è¯†ç‚¹åˆ—è¡¨ -->
                    <div class="col-md-7 p-0 ps-md-2">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>æ¦‚å¿µä¸çŸ¥è¯†ç‚¹</h6>
                                <div class="btn-group">
                                    <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" id="batchGenerateBtn" disabled>
                                        <i class="fas fa-magic"></i> æ‰¹é‡
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="batchExplainChapter()">
                                                <i class="fas fa-layer-group me-2"></i>æ‰¹é‡ç”Ÿæˆæœ¬ç« èŠ‚
                                            </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="batchExplainAll()">
                                                <i class="fas fa-globe me-2"></i>å…¨éƒ¨æ‰¹é‡ç”Ÿæˆ
                                            </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="concepts-loading" class="text-center p-4" style="display: none;">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                    <div class="mt-2">åŠ è½½ä¸­...</div>
                                </div>
                                <div class="list-group list-group-flush" id="concepts-list"
                                    style="max-height: 600px; overflow-y: auto;">
                                    <div class="list-group-item text-muted text-center py-5">
                                        <i class="fas fa-arrow-left me-2"></i>è¯·é€‰æ‹©ç« èŠ‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AIè®²è§£å†…å®¹ -->
    <div class="col-lg-7 mt-3 mt-lg-0">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center sticky-top bg-white"
                style="z-index: 100;">
                <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AIè®²è§£</h6>
                <div class="d-flex align-items-center">
                    <!-- æ“ä½œå·¥å…·æ  -->
                    <div class="btn-group me-2" id="explanation-toolbar" style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyExplanation()" title="å¤åˆ¶å†…å®¹">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="speakExplanation()" title="æœ—è¯»å†…å®¹">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>

                    <button class="btn btn-outline-warning btn-sm me-2" onclick="regenerateExplanation()"
                        id="regenerateBtn" style="display: none;">
                        <i class="fas fa-redo"></i> é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
            </div>
            <div class="card-body position-relative">
                <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
                <div id="explanation-loading" style="display: none;">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 80%"></div>
                    <div class="my-4"></div>
                    <div class="skeleton skeleton-title" style="width: 40%"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>

                <!-- å†…å®¹åŒºåŸŸ -->
                <div id="explanation-content">
                    <div class="text-muted text-center py-5">
                        <img src="https://cdn-icons-png.flaticon.com/512/6009/6009864.png" alt="AI Learning"
                            style="width: 120px; opacity: 0.5;" class="mb-3">
                        <p class="lead">ğŸ‘ˆ è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç« èŠ‚å¼€å§‹å­¦ä¹ </p>
                        <p class="small text-muted">AIå°†ä¸ºæ‚¨æä¾›è¯¦ç»†çš„æ¦‚å¿µè®²è§£å’Œä»£ç ç¤ºä¾‹</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœç´¢æ¨¡æ€æ¡† -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æœç´¢çŸ¥è¯†ç‚¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢...">
                        <button class="btn btn-primary" type="button" onclick="searchKnowledge()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="search-results">
                    <div class="text-muted text-center">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡ç”Ÿæˆè¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="batchProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>æ‰¹é‡ç”Ÿæˆè¿›åº¦
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="progress-text">å‡†å¤‡å¼€å§‹...</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            style="width: 0%" id="progress-bar">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-success" id="success-count">0</div>
                                <small class="text-muted">æˆåŠŸç”Ÿæˆ</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-danger" id="error-count">0</div>
                                <small class="text-muted">ç”Ÿæˆå¤±è´¥</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-info" id="total-count">0</div>
                                <small class="text-muted">æ€»è®¡</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">å½“å‰å¤„ç†</h6>
                    </div>
                    <div class="card-body">
                        <div id="current-processing">
                            <div class="text-muted">ç­‰å¾…å¼€å§‹...</div>
                        </div>
                    </div>
                </div>

                <div class="mt-3" id="batch-log" style="max-height: 200px; overflow-y: auto;">
                    <!-- æ‰¹é‡ç”Ÿæˆæ—¥å¿— -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="batch-close-btn" disabled>å…³é—­</button>
                <button type="button" class="btn btn-danger" id="batch-cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<!-- Mermaid.js for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    let currentChapter = '';
    let currentConcept = '';
    let currentType = '';

    $(document).ready(function () {
        // ç« èŠ‚ç‚¹å‡»äº‹ä»¶
        $('.chapter-item').click(function (e) {
            e.preventDefault();
            const chapter = $(this).data('chapter');
            selectChapter(chapter);
        });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        $('#search-input').keypress(function (e) {
            if (e.which == 13) {
                searchKnowledge();
            }
        });
    });

    function selectChapter(chapter) {
        currentChapter = chapter;

        // æ›´æ–°UIçŠ¶æ€
        $('.chapter-item').removeClass('active');
        $(`.chapter-item[data-chapter="${chapter}"]`).addClass('active');

        // å¯ç”¨æ‰¹é‡ç”ŸæˆæŒ‰é’®
        $('#batchGenerateBtn').prop('disabled', false);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $('#concepts-loading').show();
        $('#concepts-list').hide();

        // è·å–ç« èŠ‚å†…å®¹
        $.get(`/api/chapters/${encodeURIComponent(chapter)}/content`)
            .done(function (data) {
                if (data.success) {
                    displayChapterContent(data.content);
                } else {
                    showError('è·å–ç« èŠ‚å†…å®¹å¤±è´¥: ' + data.error);
                }
            })
            .fail(function () {
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .always(function () {
                $('#concepts-loading').hide();
                $('#concepts-list').show();
            });
    }

    function displayChapterContent(content) {
        const conceptsList = $('#concepts-list');
        conceptsList.empty();

        // æ˜¾ç¤ºæ¦‚å¿µ
        if (content.concepts && content.concepts.length > 0) {
            conceptsList.append('<div class="list-group-item bg-light"><strong>ä¸»è¦æ¦‚å¿µ</strong></div>');
            content.concepts.forEach(concept => {
                conceptsList.append(`
                <a href="#" class="list-group-item list-group-item-action concept-item" 
                   data-concept="${concept}" data-type="concept">
                    <i class="fas fa-lightbulb me-2 text-warning"></i>${concept}
                </a>
            `);
            });
        }

        // æ˜¾ç¤ºçŸ¥è¯†ç‚¹
        if (content.contents && content.contents.length > 0) {
            conceptsList.append('<div class="list-group-item bg-light"><strong>ä¸»è¦çŸ¥è¯†ç‚¹</strong></div>');
            content.contents.forEach(content_item => {
                conceptsList.append(`
                <a href="#" class="list-group-item list-group-item-action concept-item" 
                   data-concept="${content_item}" data-type="content">
                    <i class="fas fa-book me-2 text-info"></i>${content_item}
                </a>
            `);
            });
        }

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        $('.concept-item').click(function (e) {
            e.preventDefault();
            const concept = $(this).data('concept');
            const type = $(this).data('type');
            explainConcept(concept, type);
        });
    }

    function explainConcept(concept, type) {
        currentConcept = concept;
        currentType = type;

        // æ›´æ–°UIçŠ¶æ€
        $('.concept-item').removeClass('active');
        $(`.concept-item[data-concept="${concept}"]`).addClass('active');

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ (éª¨æ¶å±)
        $('#explanation-content').hide();
        $('#explanation-loading').show();
        $('#regenerateBtn').hide();
        $('#explanation-toolbar').hide();

        // åœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        const offcanvasEl = document.getElementById('courseNav');
        if (offcanvasEl && window.innerWidth < 992) { // lg breakpoint
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
            if (bsOffcanvas) {
                bsOffcanvas.hide();
            }
        }

        // è¯·æ±‚AIè®²è§£
        $.ajax({
            url: '/api/explain',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter,
                concept: concept,
                type: type
            })
        })
            .done(function (data) {
                if (data.success) {
                    displayExplanation(data.explanation, data.from_cache);
                } else {
                    showError('è·å–è®²è§£å¤±è´¥: ' + data.error);
                }
            })
            .fail(function () {
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .always(function () {
                $('#explanation-loading').hide();
            });
    }

    function displayExplanation(explanation, fromCache) {
        const content = $('#explanation-content');
        const cacheIndicator = fromCache ?
            '<small class="text-muted"><i class="fas fa-clock me-1"></i>æ¥è‡ªç¼“å­˜</small>' :
            '<small class="text-success"><i class="fas fa-sparkles me-1"></i>AIæ–°ç”Ÿæˆ</small>';

        // å¤„ç†å¢å¼ºæ ¼å¼çš„å†…å®¹
        const processedContent = processEnhancedContent(explanation);

        content.html(`
        <div class="mb-3 pb-2 border-bottom">
            <h4 class="d-inline-block me-2">${currentConcept}</h4>
            ${cacheIndicator}
        </div>
        <div class="explanation-content">${processedContent}</div>
    `);

        // æ˜¾ç¤ºé‡æ–°ç”ŸæˆæŒ‰é’®å’Œå·¥å…·æ 
        $('#regenerateBtn').show();
        $('#explanation-toolbar').show();

        // æ¸²æŸ“Mermaidå›¾è¡¨
        renderMermaidDiagrams();

        // ä»£ç é«˜äº® (Prism.js)
        if (window.Prism) {
            content.find('pre code').each(function () {
                // å°è¯•æ£€æµ‹è¯­è¨€
                if (!this.className && $(this).text().match(/SELECT|INSERT|UPDATE|DELETE|CREATE|DROP/i)) {
                    this.className = 'language-sql';
                } else if (!this.className) {
                    this.className = 'language-python'; // é»˜è®¤
                }
                Prism.highlightElement(this);
            });
        }

        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        content.fadeIn(500);
    }
    // å¤åˆ¶è®²è§£å†…å®¹
    function copyExplanation() {
        const content = $('.explanation-content').text();
        navigator.clipboard.writeText(content).then(() => {
            showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(err => {
            showToast('å¤åˆ¶å¤±è´¥: ' + err, 'error');
        });
    }

    // æœ—è¯»è®²è§£å†…å®¹
    function speakExplanation() {
        const content = $('.explanation-content').text();
        if ('speechSynthesis' in window) {
            // å¦‚æœæ­£åœ¨æœ—è¯»ï¼Œåˆ™åœæ­¢
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                return;
            }

            const utterance = new SpeechSynthesisUtterance(content);
            utterance.lang = 'zh-CN';
            window.speechSynthesis.speak(utterance);
            showToast('å¼€å§‹æœ—è¯»', 'info');

            utterance.onend = function () {
                showToast('æœ—è¯»ç»“æŸ', 'info');
            };
        } else {
            showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½', 'warning');
        }
    }

    function searchKnowledge() {
        const keyword = $('#search-input').val().trim();
        if (!keyword) {
            showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
            return;
        }

        $('#search-results').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">æœç´¢ä¸­...</span>
            </div>
            <p class="mt-2">æœç´¢ä¸­...</p>
        </div>
    `);

        $.get('/api/search', { keyword: keyword })
            .done(function (data) {
                if (data.success) {
                    displaySearchResults(data.results);
                } else {
                    showToast('æœç´¢å¤±è´¥: ' + data.error, 'error');
                }
            })
            .fail(function () {
                showToast('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
    }

    function displaySearchResults(results) {
        const container = $('#search-results');

        if (results.length === 0) {
            container.html(`
            <div class="text-muted text-center">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</p>
            </div>
        `);
            return;
        }

        let html = '<div class="list-group">';
        results.forEach(result => {
            const icon = result.type === 'concept' ? 'fas fa-lightbulb text-warning' : 'fas fa-book text-info';
            html += `
            <a href="#" class="list-group-item list-group-item-action search-result-item"
               data-chapter="${result.chapter}" data-concept="${result.content}" data-type="${result.type}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        <i class="${icon} me-2"></i>${result.content}
                    </h6>
                    <small class="text-muted">${result.chapter}</small>
                </div>
            </a>
        `;
        });
        html += '</div>';

        container.html(html);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        $('.search-result-item').click(function (e) {
            e.preventDefault();
            const chapter = $(this).data('chapter');
            const concept = $(this).data('concept');
            const type = $(this).data('type');

            // å…³é—­æœç´¢æ¨¡æ€æ¡†
            $('#searchModal').modal('hide');

            // é€‰æ‹©ç« èŠ‚å¹¶è§£é‡Šæ¦‚å¿µ
            selectChapter(chapter);
            setTimeout(() => {
                explainConcept(concept, type);
            }, 500);
        });
    }

    function showError(message) {
        showToast(message, 'error');
        $('#explanation-content').html(`
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `);
    }

    function processEnhancedContent(content) {
        // å¤„ç†å¢å¼ºæ ¼å¼çš„å†…å®¹
        let processedContent = content;

        // å¤„ç†è¡¨æ ¼ï¼ˆç®€å•çš„Markdownè¡¨æ ¼è½¬HTMLï¼‰
        const tableRegex = /\|(.+)\|\n\|(-+\|)+\n((?:\|.+\|\n?)*)/g;
        processedContent = processedContent.replace(tableRegex, function (match, header, separator, rows) {
            const headerCells = header.split('|').map(cell => cell.trim()).filter(cell => cell);
            const rowLines = rows.trim().split('\n');

            let tableHtml = '<table class="table table-bordered table-striped">';

            // æ·»åŠ è¡¨å¤´
            if (headerCells.length > 0) {
                tableHtml += '<thead><tr>';
                headerCells.forEach(cell => {
                    tableHtml += `<th>${cell}</th>`;
                });
                tableHtml += '</tr></thead>';
            }

            // æ·»åŠ è¡¨ä½“
            tableHtml += '<tbody>';
            rowLines.forEach(row => {
                if (row.trim()) {
                    const cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length > 0) {
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<td>${cell}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                }
            });
            tableHtml += '</tbody></table>';

            return tableHtml;
        });

        // å¤„ç†æ ‡é¢˜
        processedContent = processedContent.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        processedContent = processedContent.replace(/^### (.+)$/gm, '<h3>$1</h3>');

        // å¤„ç†åˆ—è¡¨
        processedContent = processedContent.replace(/^- (.+)$/gm, '<li>$1</li>');
        processedContent = processedContent.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');

        // å¤„ç†ç²—ä½“
        processedContent = processedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // å¤„ç†ä»£ç å— - å…ˆå¤„ç†Mermaidï¼Œé¿å…æ¢è¡Œç¬¦è¢«æ›¿æ¢
        const mermaidBlocks = [];
        processedContent = processedContent.replace(/```mermaid\n([\s\S]*?)```/g, function (match, code) {
            const placeholder = `__MERMAID_BLOCK_${mermaidBlocks.length}__`;
            mermaidBlocks.push(code.trim());
            return placeholder;
        });

        // å¤„ç†å…¶ä»–ä»£ç å—
        processedContent = processedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, function (match, lang, code) {
            return `<pre><code>${code.trim()}</code></pre>`;
        });

        // å¤„ç†è¡Œå†…ä»£ç 
        processedContent = processedContent.replace(/`([^`]+)`/g, '<code>$1</code>');

        // å¤„ç†æ¢è¡Œ
        processedContent = processedContent.replace(/\n/g, '<br>');

        // æ¢å¤Mermaidå—
        mermaidBlocks.forEach((code, index) => {
            const placeholder = `__MERMAID_BLOCK_${index}__`;
            processedContent = processedContent.replace(placeholder, `<div class="mermaid">${code}</div>`);
        });

        return processedContent;
    }

    function renderMermaidDiagrams() {
        // åˆå§‹åŒ–Mermaid
        if (typeof mermaid !== 'undefined') {
            try {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                    themeVariables: {
                        primaryColor: '#007bff',
                        primaryTextColor: '#495057',
                        primaryBorderColor: '#dee2e6',
                        lineColor: '#6c757d'
                    }
                });

                // æ¸²æŸ“æ‰€æœ‰Mermaidå›¾è¡¨
                const mermaidElements = document.querySelectorAll('.mermaid');
                mermaidElements.forEach((element, index) => {
                    try {
                        let graphDefinition = element.textContent.trim();

                        // éªŒè¯å›¾è¡¨å®šä¹‰ä¸ä¸ºç©º
                        if (!graphDefinition) {
                            element.innerHTML = `<div class="alert alert-info">æš‚æ— æµç¨‹å›¾</div>`;
                            return;
                        }

                        // æ¸…ç†å¯èƒ½çš„é—®é¢˜å­—ç¬¦å’Œæ ¼å¼
                        graphDefinition = graphDefinition
                            .replace(/[""]/g, '"')  // ç»Ÿä¸€å¼•å·
                            .replace(/['']/g, "'")  // ç»Ÿä¸€å•å¼•å·
                            .replace(/[\u200B-\u200D\uFEFF]/g, '')  // ç§»é™¤é›¶å®½å­—ç¬¦
                            .replace(/<br>/g, '\n')  // å°†<br>è½¬æ¢å›æ¢è¡Œç¬¦
                            .replace(/&nbsp;/g, ' ')  // æ›¿æ¢éæ–­ç©ºæ ¼
                            .replace(/&amp;/g, '&')  // æ›¿æ¢HTMLå®ä½“
                            .replace(/&lt;/g, '<')
                            .replace(/&gt;/g, '>');

                        // ç¡®ä¿å›¾è¡¨å®šä¹‰ä»¥æ­£ç¡®çš„è¯­æ³•å¼€å§‹
                        if (!graphDefinition.match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|journey|gitgraph|pie|gantt)/)) {
                            console.warn('å›¾è¡¨å®šä¹‰æ ¼å¼å¯èƒ½æœ‰é—®é¢˜:', graphDefinition.substring(0, 50));
                        }

                        // éªŒè¯åŸºæœ¬çš„Mermaidè¯­æ³•
                        const lines = graphDefinition.split('\n').filter(line => line.trim());
                        if (lines.length === 0) {
                            element.innerHTML = `<div class="alert alert-info">æš‚æ— æµç¨‹å›¾å†…å®¹</div>`;
                            return;
                        }

                        console.log('å‡†å¤‡æ¸²æŸ“å›¾è¡¨:', graphDefinition.substring(0, 100) + '...');

                        const graphId = `mermaid-graph-${index}-${Date.now()}`;

                        // ä½¿ç”¨Promiseå¤„ç†æ¸²æŸ“
                        mermaid.render(graphId, graphDefinition)
                            .then(({ svg }) => {
                                console.log('Mermaidæ¸²æŸ“æˆåŠŸ');
                                element.innerHTML = svg;
                            })
                            .catch(error => {
                                console.error('Mermaidæ¸²æŸ“é”™è¯¯:', error);
                                console.error('å›¾è¡¨å®šä¹‰:', graphDefinition);

                                // å°è¯•æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                let errorDetail = error.message || 'æœªçŸ¥é”™è¯¯';
                                if (error.message && error.message.includes('Parse error')) {
                                    errorDetail += '<br><small>æç¤ºï¼šå¯èƒ½æ˜¯å›¾è¡¨è¯­æ³•é”™è¯¯æˆ–åŒ…å«ç‰¹æ®Šå­—ç¬¦</small>';
                                }

                                element.innerHTML = `<div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                æµç¨‹å›¾æ¸²æŸ“å¤±è´¥ï¼š${errorDetail}
                                <details class="mt-2">
                                    <summary>æŸ¥çœ‹å›¾è¡¨å®šä¹‰</summary>
                                    <pre class="mt-2 small">${graphDefinition}</pre>
                                </details>
                            </div>`;
                            });

                    } catch (error) {
                        console.error('Mermaidå…ƒç´ å¤„ç†é”™è¯¯:', error);
                        element.innerHTML = `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        æµç¨‹å›¾å¤„ç†å¤±è´¥ï¼š${error.message}
                    </div>`;
                    }
                });

            } catch (error) {
                console.error('Mermaidåˆå§‹åŒ–é”™è¯¯:', error);
            }
        } else {
            console.warn('Mermaidåº“æœªåŠ è½½');
        }
    }

    // æ‰¹é‡ç”Ÿæˆç« èŠ‚è®²è§£
    function batchExplainChapter() {
        if (!currentChapter) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç« èŠ‚', 'warning');
            return;
        }

        // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
        $('#batchProgressModal').modal('show');

        // é‡ç½®è¿›åº¦
        resetBatchProgress();
        $('#progress-text').text(`æ­£åœ¨æäº¤ä»»åŠ¡: ${currentChapter}`);

        // å‘é€æ‰¹é‡ç”Ÿæˆè¯·æ±‚
        $.ajax({
            url: '/api/batch-explain-chapter',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter
            })
        })
            .done(function (data) {
                if (data.success) {
                    $('#progress-text').text('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...');
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    pollTaskStatus(data.task_id);
                } else {
                    showBatchError('æäº¤ä»»åŠ¡å¤±è´¥: ' + data.error);
                }
            })
            .fail(function () {
                showBatchError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    // æ‰¹é‡ç”Ÿæˆå…¨éƒ¨è®²è§£
    function batchExplainAll() {
        if (!confirm('è¿™å°†ç”Ÿæˆæ‰€æœ‰ç« èŠ‚çš„æ‰€æœ‰æ¦‚å¿µå’ŒçŸ¥è¯†ç‚¹è®²è§£ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            return;
        }

        // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
        $('#batchProgressModal').modal('show');

        // é‡ç½®è¿›åº¦
        resetBatchProgress();
        $('#progress-text').text('æ­£åœ¨æäº¤å…¨éƒ¨ç”Ÿæˆä»»åŠ¡...');

        // å‘é€æ‰¹é‡ç”Ÿæˆè¯·æ±‚
        $.ajax({
            url: '/api/batch-explain-all',
            method: 'POST',
            contentType: 'application/json'
        })
            .done(function (data) {
                if (data.success) {
                    $('#progress-text').text('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...');
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    pollTaskStatus(data.task_id);
                } else {
                    showBatchError('æäº¤ä»»åŠ¡å¤±è´¥: ' + data.error);
                }
            })
            .fail(function () {
                showBatchError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    let pollInterval = null;

    function pollTaskStatus(taskId) {
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢
        if (pollInterval) {
            clearInterval(pollInterval);
        }

        pollInterval = setInterval(function () {
            $.get(`/api/tasks/${taskId}/status`)
                .done(function (data) {
                    if (data.success) {
                        const task = data.task;
                        updateBatchProgress(task);

                        if (task.status === 'completed') {
                            clearInterval(pollInterval);
                            handleBatchResult(task.result);
                        } else if (task.status === 'failed') {
                            clearInterval(pollInterval);
                            showBatchError('ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ' + task.error);
                        }
                    }
                })
                .fail(function () {
                    // ç½‘ç»œé”™è¯¯ä¸ç«‹å³åœæ­¢ï¼Œå¯èƒ½æ˜¯æš‚æ—¶çš„
                    console.warn('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼Œé‡è¯•ä¸­...');
                });
        }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    }

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    function updateBatchProgress(task) {
        const percentage = Math.round(task.progress || 0);
        $('#progress-bar').css('width', percentage + '%');
        $('#progress-percentage').text(percentage + '%');
        $('#progress-text').text(task.message || 'æ­£åœ¨å¤„ç†...');

        // å¦‚æœæœ‰è¯¦ç»†è¿›åº¦ä¿¡æ¯
        if (task.details) {
            $('#current-processing').html(`
            <div class="text-primary">
                <i class="fas fa-spinner fa-spin me-2"></i>
                æ­£åœ¨ç”Ÿæˆ: ${task.details.chapter || ''} - ${task.details.concept || ''}
            </div>
        `);

            // æ·»åŠ æ—¥å¿—
            if (task.details.concept && !task.details.error) {
                // é¿å…é‡å¤æ—¥å¿—ï¼Œè¿™é‡Œå¯ä»¥ä¼˜åŒ–ï¼Œæ¯”å¦‚åªæ˜¾ç¤ºæœ€è¿‘çš„ä¸€æ¡
            }
        }
    }

    // é‡æ–°ç”Ÿæˆå½“å‰è®²è§£
    function regenerateExplanation() {
        if (!currentChapter || !currentConcept || !currentType) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¦‚å¿µæˆ–çŸ¥è¯†ç‚¹', 'warning');
            return;
        }

        if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆå½“å‰è®²è§£å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰å†…å®¹ã€‚')) {
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $('#explanation-content').hide();
        $('#explanation-loading').show();
        $('#regenerateBtn').hide();
        $('#explanation-toolbar').hide();

        // å‘é€é‡æ–°ç”Ÿæˆè¯·æ±‚
        $.ajax({
            url: '/api/regenerate-explain',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter,
                concept: currentConcept,
                type: currentType
            })
        })
            .done(function (data) {
                if (data.success) {
                    displayExplanation(data.explanation, data.from_cache);
                    showToast('é‡æ–°ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    showError('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + data.error);
                }
            })
            .fail(function () {
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .always(function () {
                $('#explanation-loading').hide();
            });
    }

    // é‡ç½®æ‰¹é‡è¿›åº¦
    function resetBatchProgress() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }

        $('#progress-bar').css('width', '0%');
        $('#progress-percentage').text('0%');
        $('#success-count').text('0');
        $('#error-count').text('0');
        $('#total-count').text('0');
        $('#current-processing').html('<div class="text-muted">ç­‰å¾…å¼€å§‹...</div>');
        $('#batch-log').empty();
        $('#batch-close-btn').prop('disabled', true);
        $('#batch-cancel-btn').prop('disabled', false);
    }

    // å¤„ç†æ‰¹é‡ç”Ÿæˆç»“æœ
    function handleBatchResult(result) {
        if (!result) return;

        $('#total-count').text(result.total || 0);
        $('#success-count').text(result.success_count || 0);
        $('#error-count').text(result.error_count || 0);

        const percentage = 100;
        $('#progress-bar').css('width', percentage + '%');
        $('#progress-percentage').text(percentage + '%');
        $('#progress-text').text('æ‰¹é‡ç”Ÿæˆå®Œæˆ');

        $('#current-processing').html(`
        <div class="text-success">
            <i class="fas fa-check-circle me-2"></i>æ‰¹é‡ç”Ÿæˆå®Œæˆ
        </div>
    `);

        // æ·»åŠ å®Œæˆæ—¥å¿—
        $('#batch-log').append(`
        <div class="alert alert-success">
            <strong>æ‰¹é‡ç”Ÿæˆå®Œæˆï¼</strong><br>
            æˆåŠŸç”Ÿæˆ: ${result.success_count} ä¸ª<br>
            ç”Ÿæˆå¤±è´¥: ${result.error_count} ä¸ª<br>
            æ€»è®¡: ${result.total} ä¸ª
        </div>
    `);

        $('#batch-close-btn').prop('disabled', false);
        $('#batch-cancel-btn').prop('disabled', true);

        // å¦‚æœå½“å‰ç« èŠ‚æœ‰æ›´æ–°ï¼Œåˆ·æ–°æ¦‚å¿µåˆ—è¡¨
        if (currentChapter) {
            selectChapter(currentChapter);
        }
    }

    // æ˜¾ç¤ºæ‰¹é‡ç”Ÿæˆé”™è¯¯
    function showBatchError(message) {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }

        $('#current-processing').html(`
        <div class="text-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `);

        $('#batch-log').append(`
        <div class="alert alert-danger">
            <strong>é”™è¯¯ï¼š</strong>${message}
        </div>
    `);

        showToast('æ‰¹é‡ç”Ÿæˆå‡ºé”™', 'error');

        $('#batch-close-btn').prop('disabled', false);
        $('#batch-cancel-btn').prop('disabled', true);
    }

    // ç»‘å®šæ‰¹é‡è¿›åº¦æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
    $(document).ready(function () {
        $('#batch-close-btn').click(function () {
            $('#batchProgressModal').modal('hide');
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        });

        $('#batch-cancel-btn').click(function () {
            if (confirm('ç¡®å®šè¦åœæ­¢ç›‘æ§è¿›åº¦å—ï¼Ÿåå°ä»»åŠ¡å¯èƒ½ä»åœ¨ç»§ç»­è¿è¡Œã€‚')) {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
                $('#batchProgressModal').modal('hide');
            }
        });
    });
</script>
{% endblock %}