{% extends "base.html" %}

{% block title %}学习 - 通用智能学习系统{% endblock %}

{% block extra_css %}
<!-- Mermaid CSS -->
<style>
    .mermaid {
        text-align: center;
        margin: 20px 0;
    }

    .explanation-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .explanation-content table th,
    .explanation-content table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: left;
    }

    .explanation-content table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .explanation-content table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .explanation-content h2 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-top: 25px;
        margin-bottom: 15px;
    }

    .explanation-content h3 {
        color: #6c757d;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .explanation-content code {
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }

    .explanation-content pre {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-book me-2"></i>智能学习</h2>
            <div>
                <button class="btn btn-outline-primary btn-sm" onclick="showProgress()">
                    <i class="fas fa-chart-line me-1"></i>学习进度
                </button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search me-1"></i>搜索知识点
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Mobile Toggle Button -->
    <div class="col-12 d-lg-none mb-3">
        <button class="btn btn-primary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#courseNav">
            <i class="fas fa-list me-2"></i>浏览章节与知识点
        </button>
    </div>

    <!-- Navigation Sidebar (Offcanvas on mobile, Column on desktop) -->
    <!-- Navigation Sidebar -->
    <div class="col-lg-4 mb-4 mb-lg-0">
        <div class="offcanvas-lg offcanvas-start bg-body" tabindex="-1" id="courseNav">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title fw-bold">课程导航</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                    data-bs-target="#courseNav"></button>
            </div>
            <div class="offcanvas-body d-block p-0">
                <div class="row g-3">
                    <!-- 章节列表 -->
                    <div class="col-12">
                        <div class="card shadow-sm h-100 border-0">
                            <div class="card-header bg-white border-0 pt-3 pb-2">
                                <h6 class="mb-0 fw-bold text-uppercase text-muted small"><i
                                        class="fas fa-list me-2"></i>章节列表</h6>
                            </div>
                            <div class="card-body p-2">
                                <div class="list-group list-group-flush chapter-list" id="chapters-list"
                                    style="max-height: 300px; overflow-y: auto;">
                                    {% for chapter in chapters %}
                                    <a href="#"
                                        class="list-group-item list-group-item-action border-0 rounded-2 mb-1 px-3 py-2 chapter-item"
                                        data-chapter="{{ chapter }}">
                                        {{ chapter }}
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 概念和知识点列表 -->
                    <div class="col-12">
                        <div class="card shadow-sm h-100 border-0">
                            <div
                                class="card-header bg-white border-0 pt-3 pb-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold text-uppercase text-muted small"><i
                                        class="fas fa-lightbulb me-2"></i>知识点</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle py-0" type="button"
                                        data-bs-toggle="dropdown" id="batchGenerateBtn" disabled>
                                        批量生成
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                        <li><a class="dropdown-item" href="#" onclick="batchExplainChapter()"><i
                                                    class="fas fa-layer-group me-2"></i>本章全部</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="batchExplainAll()"><i
                                                    class="fas fa-globe me-2"></i>所有章节</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <div id="concepts-loading" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <div class="mt-2 small text-muted">加载中...</div>
                                </div>
                                <div class="list-group list-group-flush" id="concepts-list"
                                    style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center py-5 text-muted small">
                                        <i class="fas fa-arrow-up mb-2 d-block"></i>请先选择一个章节
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI讲解内容 -->
    <div class="col-lg-8">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-white border-bottom py-3 sticky-top"
                style="z-index: 100; backdrop-filter: blur(10px); background: rgba(255,255,255,0.95);">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-robot me-2"></i>AI 智能讲解</h5>
                    <div class="d-flex align-items-center gap-2">
                        <!-- 操作工具栏 -->
                        <div class="btn-group" id="explanation-toolbar" style="display: none;">
                            <button class="btn btn-light btn-sm" onclick="copyExplanation()" title="复制与分享">
                                <i class="fas fa-copy text-muted"></i>
                            </button>
                            <button class="btn btn-light btn-sm" onclick="speakExplanation()" title="朗读">
                                <i class="fas fa-volume-up text-muted"></i>
                            </button>
                        </div>

                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3"
                            onclick="regenerateExplanation()" id="regenerateBtn" style="display: none;">
                            <i class="fas fa-redo me-1"></i> 重新生成
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-4 position-relative">
                <!-- 骨架屏加载状态 -->
                <div id="explanation-loading" style="display: none;">
                    <div class="skeleton skeleton-title w-50 mb-4"></div>
                    <div class="skeleton skeleton-text mb-2"></div>
                    <div class="skeleton skeleton-text mb-2"></div>
                    <div class="skeleton skeleton-text w-75 mb-4"></div>
                    <div class="skeleton skeleton-title w-25 mb-3"></div>
                    <div class="skeleton skeleton-text mb-2"></div>
                    <div class="skeleton skeleton-text mb-2"></div>
                </div>

                <!-- 内容区域 -->
                <div id="explanation-content" class="explanation-wrapper">
                    <div class="text-center py-5 my-5">
                        <div class="mb-4">
                            <i class="fas fa-graduation-cap fa-4x text-light"></i>
                        </div>
                        <h4 class="text-muted fw-light">准备开始学习</h4>
                        <p class="text-muted small mt-2">请在左侧选择章节和知识点，AI将为您提供深度解析</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 搜索模态框 -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">搜索知识点</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input" placeholder="输入关键词搜索...">
                        <button class="btn btn-primary" type="button" onclick="searchKnowledge()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="search-results">
                    <div class="text-muted text-center">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>输入关键词开始搜索</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量生成进度模态框 -->
<div class="modal fade" id="batchProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>批量生成进度
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="progress-text">准备开始...</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            style="width: 0%" id="progress-bar">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-success" id="success-count">0</div>
                                <small class="text-muted">成功生成</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-danger" id="error-count">0</div>
                                <small class="text-muted">生成失败</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-info" id="total-count">0</div>
                                <small class="text-muted">总计</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">当前处理</h6>
                    </div>
                    <div class="card-body">
                        <div id="current-processing">
                            <div class="text-muted">等待开始...</div>
                        </div>
                    </div>
                </div>

                <div class="mt-3" id="batch-log" style="max-height: 200px; overflow-y: auto;">
                    <!-- 批量生成日志 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="batch-close-btn" disabled>关闭</button>
                <button type="button" class="btn btn-danger" id="batch-cancel-btn">取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<!-- Mermaid.js for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    let currentChapter = '';
    let currentConcept = '';
    let currentType = '';

    $(document).ready(function () {
        // 章节点击事件
        $('.chapter-item').click(function (e) {
            e.preventDefault();
            const chapter = $(this).data('chapter');
            selectChapter(chapter);
        });

        // 搜索框回车事件
        $('#search-input').keypress(function (e) {
            if (e.which == 13) {
                searchKnowledge();
            }
        });
    });

    function selectChapter(chapter) {
        currentChapter = chapter;

        // 更新UI状态
        $('.chapter-item').removeClass('active');
        $(`.chapter-item[data-chapter="${chapter}"]`).addClass('active');

        // 启用批量生成按钮
        $('#batchGenerateBtn').prop('disabled', false);

        // 显示加载状态
        $('#concepts-loading').show();
        $('#concepts-list').hide();

        // 获取章节内容
        $.get(`/api/chapters/${encodeURIComponent(chapter)}/content`)
            .done(function (data) {
                if (data.success) {
                    displayChapterContent(data.content);
                } else {
                    showError('获取章节内容失败: ' + data.error);
                }
            })
            .fail(function () {
                showError('网络错误，请稍后重试');
            })
            .always(function () {
                $('#concepts-loading').hide();
                $('#concepts-list').show();
            });
    }

    function displayChapterContent(content) {
        const conceptsList = $('#concepts-list');
        conceptsList.empty();

        // 显示概念
        if (content.concepts && content.concepts.length > 0) {
            conceptsList.append('<div class="list-group-item bg-light small fw-bold text-uppercase py-2">主要概念</div>');
            content.concepts.forEach(concept => {
                conceptsList.append(`
                <a href="#" class="list-group-item list-group-item-action concept-item border-0 rounded-2 mb-1 px-3 py-2" 
                   data-concept="${concept}" data-type="concept">
                    <i class="fas fa-lightbulb me-2 text-warning"></i>${concept}
                </a>
            `);
            });
        }

        // 显示知识点
        if (content.contents && content.contents.length > 0) {
            conceptsList.append('<div class="list-group-item bg-light small fw-bold text-uppercase py-2 mt-2">主要知识点</div>');
            content.contents.forEach(content_item => {
                conceptsList.append(`
                <a href="#" class="list-group-item list-group-item-action concept-item border-0 rounded-2 mb-1 px-3 py-2" 
                   data-concept="${content_item}" data-type="content">
                    <i class="fas fa-book me-2 text-info"></i>${content_item}
                </a>
            `);
            });
        }

        // 绑定点击事件
        $('.concept-item').click(function (e) {
            e.preventDefault();
            const concept = $(this).data('concept');
            const type = $(this).data('type');
            explainConcept(concept, type);
        });
    }

    function explainConcept(concept, type) {
        currentConcept = concept;
        currentType = type;

        // 更新UI状态
        $('.concept-item').removeClass('active');
        $(`.concept-item[data-concept="${concept}"]`).addClass('active');

        // 显示加载状态 (骨架屏)
        $('#explanation-content').hide();
        $('#explanation-loading').show();
        $('#regenerateBtn').hide();
        $('#explanation-toolbar').hide();

        // 在移动端自动关闭侧边栏
        const offcanvasEl = document.getElementById('courseNav');
        if (offcanvasEl && window.innerWidth < 992) { // lg breakpoint
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
            if (bsOffcanvas) {
                bsOffcanvas.hide();
            }
        }

        // 请求AI讲解
        $.ajax({
            url: '/api/explain',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter,
                concept: concept,
                type: type
            })
        })
            .done(function (data) {
                if (data.success) {
                    displayExplanation(data.explanation, data.from_cache);
                } else {
                    showError('获取讲解失败: ' + data.error);
                }
            })
            .fail(function () {
                showError('网络错误，请稍后重试');
            })
            .always(function () {
                $('#explanation-loading').hide();
            });
    }

    function displayExplanation(explanation, fromCache) {
        const content = $('#explanation-content');
        const cacheIndicator = fromCache ?
            '<small class="text-muted"><i class="fas fa-clock me-1"></i>来自缓存</small>' :
            '<small class="text-success"><i class="fas fa-sparkles me-1"></i>AI新生成</small>';

        // 处理增强格式的内容
        const processedContent = processEnhancedContent(explanation);

        content.html(`
        <div class="mb-3 pb-2 border-bottom">
            <h4 class="d-inline-block me-2">${currentConcept}</h4>
            ${cacheIndicator}
        </div>
        <div class="explanation-content">${processedContent}</div>
    `);

        // 显示重新生成按钮和工具栏
        $('#regenerateBtn').show();
        $('#explanation-toolbar').show();

        // 渲染Mermaid图表
        renderMermaidDiagrams();

        // 代码高亮 (Prism.js)
        if (window.Prism) {
            content.find('pre code').each(function () {
                // 尝试检测语言
                if (!this.className && $(this).text().match(/SELECT|INSERT|UPDATE|DELETE|CREATE|DROP/i)) {
                    this.className = 'language-sql';
                } else if (!this.className) {
                    this.className = 'language-python'; // 默认
                }
                Prism.highlightElement(this);
            });
        }

        // 添加动画效果
        content.fadeIn(500);
    }
    // 复制讲解内容
    function copyExplanation() {
        const content = $('.explanation-content').text();
        navigator.clipboard.writeText(content).then(() => {
            showToast('内容已复制到剪贴板', 'success');
        }).catch(err => {
            showToast('复制失败: ' + err, 'error');
        });
    }

    // 朗读讲解内容
    function speakExplanation() {
        const content = $('.explanation-content').text();
        if ('speechSynthesis' in window) {
            // 如果正在朗读，则停止
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                return;
            }

            const utterance = new SpeechSynthesisUtterance(content);
            utterance.lang = 'zh-CN';
            window.speechSynthesis.speak(utterance);
            showToast('开始朗读', 'info');

            utterance.onend = function () {
                showToast('朗读结束', 'info');
            };
        } else {
            showToast('您的浏览器不支持朗读功能', 'warning');
        }
    }

    function searchKnowledge() {
        const keyword = $('#search-input').val().trim();
        if (!keyword) {
            showToast('请输入搜索关键词', 'warning');
            return;
        }

        $('#search-results').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">搜索中...</span>
            </div>
            <p class="mt-2">搜索中...</p>
        </div>
    `);

        $.get('/api/search', { keyword: keyword })
            .done(function (data) {
                if (data.success) {
                    displaySearchResults(data.results);
                } else {
                    showToast('搜索失败: ' + data.error, 'error');
                }
            })
            .fail(function () {
                showToast('搜索失败，请稍后重试', 'error');
            });
    }

    function displaySearchResults(results) {
        const container = $('#search-results');

        if (results.length === 0) {
            container.html(`
            <div class="text-muted text-center">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>没有找到相关内容</p>
            </div>
        `);
            return;
        }

        let html = '<div class="list-group">';
        results.forEach(result => {
            const icon = result.type === 'concept' ? 'fas fa-lightbulb text-warning' : 'fas fa-book text-info';
            html += `
            <a href="#" class="list-group-item list-group-item-action search-result-item"
               data-chapter="${result.chapter}" data-concept="${result.content}" data-type="${result.type}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        <i class="${icon} me-2"></i>${result.content}
                    </h6>
                    <small class="text-muted">${result.chapter}</small>
                </div>
            </a>
        `;
        });
        html += '</div>';

        container.html(html);

        // 绑定点击事件
        $('.search-result-item').click(function (e) {
            e.preventDefault();
            const chapter = $(this).data('chapter');
            const concept = $(this).data('concept');
            const type = $(this).data('type');

            // 关闭搜索模态框
            $('#searchModal').modal('hide');

            // 选择章节并解释概念
            selectChapter(chapter);
            setTimeout(() => {
                explainConcept(concept, type);
            }, 500);
        });
    }

    function showError(message) {
        showToast(message, 'error');
        $('#explanation-content').html(`
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `);
    }

    function processEnhancedContent(content) {
        // 处理增强格式的内容
        let processedContent = content;

        // 处理表格（简单的Markdown表格转HTML）
        const tableRegex = /\|(.+)\|\n\|(-+\|)+\n((?:\|.+\|\n?)*)/g;
        processedContent = processedContent.replace(tableRegex, function (match, header, separator, rows) {
            const headerCells = header.split('|').map(cell => cell.trim()).filter(cell => cell);
            const rowLines = rows.trim().split('\n');

            let tableHtml = '<table class="table table-bordered table-striped">';

            // 添加表头
            if (headerCells.length > 0) {
                tableHtml += '<thead><tr>';
                headerCells.forEach(cell => {
                    tableHtml += `<th>${cell}</th>`;
                });
                tableHtml += '</tr></thead>';
            }

            // 添加表体
            tableHtml += '<tbody>';
            rowLines.forEach(row => {
                if (row.trim()) {
                    const cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length > 0) {
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<td>${cell}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                }
            });
            tableHtml += '</tbody></table>';

            return tableHtml;
        });

        // 处理标题
        processedContent = processedContent.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        processedContent = processedContent.replace(/^### (.+)$/gm, '<h3>$1</h3>');

        // 处理列表
        processedContent = processedContent.replace(/^- (.+)$/gm, '<li>$1</li>');
        processedContent = processedContent.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');

        // 处理粗体
        processedContent = processedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // 处理代码块 - 先处理Mermaid，避免换行符被替换
        const mermaidBlocks = [];
        processedContent = processedContent.replace(/```mermaid\n([\s\S]*?)```/g, function (match, code) {
            const placeholder = `__MERMAID_BLOCK_${mermaidBlocks.length}__`;
            mermaidBlocks.push(code.trim());
            return placeholder;
        });

        // 处理其他代码块
        processedContent = processedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, function (match, lang, code) {
            return `<pre><code>${code.trim()}</code></pre>`;
        });

        // 处理行内代码
        processedContent = processedContent.replace(/`([^`]+)`/g, '<code>$1</code>');

        // 处理换行
        processedContent = processedContent.replace(/\n/g, '<br>');

        // 恢复Mermaid块
        mermaidBlocks.forEach((code, index) => {
            const placeholder = `__MERMAID_BLOCK_${index}__`;
            processedContent = processedContent.replace(placeholder, `<div class="mermaid">${code}</div>`);
        });

        return processedContent;
    }

    function renderMermaidDiagrams() {
        // 初始化Mermaid
        if (typeof mermaid !== 'undefined') {
            try {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                    themeVariables: {
                        primaryColor: '#007bff',
                        primaryTextColor: '#495057',
                        primaryBorderColor: '#dee2e6',
                        lineColor: '#6c757d'
                    }
                });

                // 渲染所有Mermaid图表
                const mermaidElements = document.querySelectorAll('.mermaid');
                mermaidElements.forEach((element, index) => {
                    try {
                        let graphDefinition = element.textContent.trim();

                        // 验证图表定义不为空
                        if (!graphDefinition) {
                            element.innerHTML = `<div class="alert alert-info">暂无流程图</div>`;
                            return;
                        }

                        // 清理可能的问题字符和格式
                        graphDefinition = graphDefinition
                            .replace(/[""]/g, '"')  // 统一引号
                            .replace(/['']/g, "'")  // 统一单引号
                            .replace(/[\u200B-\u200D\uFEFF]/g, '')  // 移除零宽字符
                            .replace(/<br>/g, '\n')  // 将<br>转换回换行符
                            .replace(/&nbsp;/g, ' ')  // 替换非断空格
                            .replace(/&amp;/g, '&')  // 替换HTML实体
                            .replace(/&lt;/g, '<')
                            .replace(/&gt;/g, '>');

                        // 确保图表定义以正确的语法开始
                        if (!graphDefinition.match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|journey|gitgraph|pie|gantt)/)) {
                            console.warn('图表定义格式可能有问题:', graphDefinition.substring(0, 50));
                        }

                        // 验证基本的Mermaid语法
                        const lines = graphDefinition.split('\n').filter(line => line.trim());
                        if (lines.length === 0) {
                            element.innerHTML = `<div class="alert alert-info">暂无流程图内容</div>`;
                            return;
                        }

                        console.log('准备渲染图表:', graphDefinition.substring(0, 100) + '...');

                        const graphId = `mermaid-graph-${index}-${Date.now()}`;

                        // 使用Promise处理渲染
                        mermaid.render(graphId, graphDefinition)
                            .then(({ svg }) => {
                                console.log('Mermaid渲染成功');
                                element.innerHTML = svg;
                            })
                            .catch(error => {
                                console.error('Mermaid渲染错误:', error);
                                console.error('图表定义:', graphDefinition);

                                // 尝试提供更详细的错误信息
                                let errorDetail = error.message || '未知错误';
                                if (error.message && error.message.includes('Parse error')) {
                                    errorDetail += '<br><small>提示：可能是图表语法错误或包含特殊字符</small>';
                                }

                                element.innerHTML = `<div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                流程图渲染失败：${errorDetail}
                                <details class="mt-2">
                                    <summary>查看图表定义</summary>
                                    <pre class="mt-2 small">${graphDefinition}</pre>
                                </details>
                            </div>`;
                            });

                    } catch (error) {
                        console.error('Mermaid元素处理错误:', error);
                        element.innerHTML = `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        流程图处理失败：${error.message}
                    </div>`;
                    }
                });

            } catch (error) {
                console.error('Mermaid初始化错误:', error);
            }
        } else {
            console.warn('Mermaid库未加载');
        }
    }

    // 批量生成章节讲解
    function batchExplainChapter() {
        if (!currentChapter) {
            showToast('请先选择一个章节', 'warning');
            return;
        }

        // 显示进度模态框
        $('#batchProgressModal').modal('show');

        // 重置进度
        resetBatchProgress();
        $('#progress-text').text(`正在提交任务: ${currentChapter}`);

        // 发送批量生成请求
        $.ajax({
            url: '/api/batch-explain-chapter',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter
            })
        })
            .done(function (data) {
                if (data.success) {
                    $('#progress-text').text('任务已提交，正在处理...');
                    // 开始轮询任务状态
                    pollTaskStatus(data.task_id);
                } else {
                    showBatchError('提交任务失败: ' + data.error);
                }
            })
            .fail(function () {
                showBatchError('网络错误，请稍后重试');
            });
    }

    // 批量生成全部讲解
    function batchExplainAll() {
        if (!confirm('这将生成所有章节的所有概念和知识点讲解，可能需要较长时间。确定继续吗？')) {
            return;
        }

        // 显示进度模态框
        $('#batchProgressModal').modal('show');

        // 重置进度
        resetBatchProgress();
        $('#progress-text').text('正在提交全部生成任务...');

        // 发送批量生成请求
        $.ajax({
            url: '/api/batch-explain-all',
            method: 'POST',
            contentType: 'application/json'
        })
            .done(function (data) {
                if (data.success) {
                    $('#progress-text').text('任务已提交，正在处理...');
                    // 开始轮询任务状态
                    pollTaskStatus(data.task_id);
                } else {
                    showBatchError('提交任务失败: ' + data.error);
                }
            })
            .fail(function () {
                showBatchError('网络错误，请稍后重试');
            });
    }

    // 轮询任务状态
    let pollInterval = null;

    function pollTaskStatus(taskId) {
        // 清除可能存在的旧轮询
        if (pollInterval) {
            clearInterval(pollInterval);
        }

        pollInterval = setInterval(function () {
            $.get(`/api/tasks/${taskId}/status`)
                .done(function (data) {
                    if (data.success) {
                        const task = data.task;
                        updateBatchProgress(task);

                        if (task.status === 'completed') {
                            clearInterval(pollInterval);
                            handleBatchResult(task.result);
                        } else if (task.status === 'failed') {
                            clearInterval(pollInterval);
                            showBatchError('任务执行失败: ' + task.error);
                        }
                    }
                })
                .fail(function () {
                    // 网络错误不立即停止，可能是暂时的
                    console.warn('获取任务状态失败，重试中...');
                });
        }, 2000); // 每2秒轮询一次
    }

    // 更新进度显示
    function updateBatchProgress(task) {
        const percentage = Math.round(task.progress || 0);
        $('#progress-bar').css('width', percentage + '%');
        $('#progress-percentage').text(percentage + '%');
        $('#progress-text').text(task.message || '正在处理...');

        // 如果有详细进度信息
        if (task.details) {
            $('#current-processing').html(`
            <div class="text-primary">
                <i class="fas fa-spinner fa-spin me-2"></i>
                正在生成: ${task.details.chapter || ''} - ${task.details.concept || ''}
            </div>
        `);

            // 添加日志
            if (task.details.concept && !task.details.error) {
                // 避免重复日志，这里可以优化，比如只显示最近的一条
            }
        }
    }

    // 重新生成当前讲解
    function regenerateExplanation() {
        if (!currentChapter || !currentConcept || !currentType) {
            showToast('请先选择一个概念或知识点', 'warning');
            return;
        }

        if (!confirm('确定要重新生成当前讲解吗？这将覆盖现有内容。')) {
            return;
        }

        // 显示加载状态
        $('#explanation-content').hide();
        $('#explanation-loading').show();
        $('#regenerateBtn').hide();
        $('#explanation-toolbar').hide();

        // 发送重新生成请求
        $.ajax({
            url: '/api/regenerate-explain',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chapter: currentChapter,
                concept: currentConcept,
                type: currentType
            })
        })
            .done(function (data) {
                if (data.success) {
                    displayExplanation(data.explanation, data.from_cache);
                    showToast('重新生成成功', 'success');
                } else {
                    showError('重新生成失败: ' + data.error);
                }
            })
            .fail(function () {
                showError('网络错误，请稍后重试');
            })
            .always(function () {
                $('#explanation-loading').hide();
            });
    }

    // 重置批量进度
    function resetBatchProgress() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }

        $('#progress-bar').css('width', '0%');
        $('#progress-percentage').text('0%');
        $('#success-count').text('0');
        $('#error-count').text('0');
        $('#total-count').text('0');
        $('#current-processing').html('<div class="text-muted">等待开始...</div>');
        $('#batch-log').empty();
        $('#batch-close-btn').prop('disabled', true);
        $('#batch-cancel-btn').prop('disabled', false);
    }

    // 处理批量生成结果
    function handleBatchResult(result) {
        if (!result) return;

        $('#total-count').text(result.total || 0);
        $('#success-count').text(result.success_count || 0);
        $('#error-count').text(result.error_count || 0);

        const percentage = 100;
        $('#progress-bar').css('width', percentage + '%');
        $('#progress-percentage').text(percentage + '%');
        $('#progress-text').text('批量生成完成');

        $('#current-processing').html(`
        <div class="text-success">
            <i class="fas fa-check-circle me-2"></i>批量生成完成
        </div>
    `);

        // 添加完成日志
        $('#batch-log').append(`
        <div class="alert alert-success">
            <strong>批量生成完成！</strong><br>
            成功生成: ${result.success_count} 个<br>
            生成失败: ${result.error_count} 个<br>
            总计: ${result.total} 个
        </div>
    `);

        $('#batch-close-btn').prop('disabled', false);
        $('#batch-cancel-btn').prop('disabled', true);

        // 如果当前章节有更新，刷新概念列表
        if (currentChapter) {
            selectChapter(currentChapter);
        }
    }

    // 显示批量生成错误
    function showBatchError(message) {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }

        $('#current-processing').html(`
        <div class="text-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `);

        $('#batch-log').append(`
        <div class="alert alert-danger">
            <strong>错误：</strong>${message}
        </div>
    `);

        showToast('批量生成出错', 'error');

        $('#batch-close-btn').prop('disabled', false);
        $('#batch-cancel-btn').prop('disabled', true);
    }

    // 绑定批量进度模态框关闭事件
    $(document).ready(function () {
        $('#batch-close-btn').click(function () {
            $('#batchProgressModal').modal('hide');
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        });

        $('#batch-cancel-btn').click(function () {
            if (confirm('确定要停止监控进度吗？后台任务可能仍在继续运行。')) {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
                $('#batchProgressModal').modal('hide');
            }
        });
    });
</script>
{% endblock %}